import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, '..');

const sourcePath = path.join(repoRoot, 'mechanisms', 'definitions', 'curated-overrides.json');
const outputPaths = [
  path.join(repoRoot, 'src', 'js', 'mechanism-definitions.js'),
  path.join(repoRoot, 'public', 'js', 'mechanism-definitions.js'),
];

function loadCuratedOverrides() {
  const raw = fs.readFileSync(sourcePath, 'utf8');
  const parsed = JSON.parse(raw);
  if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
    throw new Error('curated-overrides.json must be a plain object keyed by animationId.');
  }

  const normalized = {};
  Object.keys(parsed)
    .sort()
    .forEach((animationId) => {
      const definition = parsed[animationId];
      if (!definition || typeof definition !== 'object' || Array.isArray(definition)) {
        throw new Error(`Definition "${animationId}" must be an object.`);
      }
      if (definition.id !== animationId) {
        throw new Error(`Definition "${animationId}" must include matching id field.`);
      }
      normalized[animationId] = definition;
    });

  return normalized;
}

function buildModuleSource(definitions) {
  return `// Auto-generated by scripts/sync-mechanism-definitions.mjs
// Source of truth: mechanisms/definitions/curated-overrides.json
(function initOrganicMapMechanismDefinitions(globalScope) {
    const definitions = ${JSON.stringify(definitions, null, 4)};

    if (typeof window !== 'undefined') {
        window.OrganicMapMechanismDefinitions = definitions;
    }

    if (typeof module !== 'undefined' && module.exports) {
        module.exports = definitions;
    }

    if (globalScope && typeof globalScope === 'object') {
        globalScope.OrganicMapMechanismDefinitions = definitions;
    }
})(typeof globalThis !== 'undefined' ? globalThis : this);
`;
}

const definitions = loadCuratedOverrides();
const moduleSource = buildModuleSource(definitions);

outputPaths.forEach((outputPath) => {
  fs.mkdirSync(path.dirname(outputPath), { recursive: true });
  fs.writeFileSync(outputPath, moduleSource);
});

console.log(`Synced mechanism definitions to ${outputPaths.length} targets.`);
