<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanism Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/mechanism-definitions.js?v=20260220a"></script>
    <script src="js/mechanism-canvas-renderer.js?v=20260220a"></script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100">
    <main class="mx-auto max-w-7xl p-4 sm:p-6">
        <header class="mb-6 rounded-xl border border-slate-700 bg-slate-900/80 p-4">
            <h1 class="text-2xl font-bold">Mechanism Preview</h1>
            <p class="mt-2 text-sm text-slate-300">
                Inspect curated M2 mechanism definitions before wiring them into map interactions.
            </p>
        </header>

        <section class="grid gap-4 lg:grid-cols-[320px_1fr]">
            <aside class="rounded-xl border border-slate-700 bg-slate-900/80 p-4">
                <label for="mechanismSelect" class="block text-xs font-semibold uppercase tracking-wide text-slate-300">
                    Mechanism ID
                </label>
                <select id="mechanismSelect"
                    class="mt-2 w-full rounded border border-slate-600 bg-slate-800 px-3 py-2 text-sm text-slate-100"></select>
                <p id="mechanismCount" class="mt-2 text-xs text-slate-400"></p>
            </aside>

            <section class="space-y-4">
                <article class="rounded-xl border border-slate-700 bg-slate-900/80 p-4">
                    <h2 id="definitionTitle" class="text-xl font-semibold text-white"></h2>
                    <p id="definitionSummary" class="mt-2 text-sm text-slate-300"></p>
                    <div class="mt-4 grid gap-4 md:grid-cols-2">
                        <div class="rounded border border-slate-700 bg-slate-950/70 p-3">
                            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Step sequence</p>
                            <ol id="definitionSteps" class="mt-2 list-decimal space-y-1 pl-5 text-sm text-slate-200"></ol>
                        </div>
                        <div class="rounded border border-slate-700 bg-slate-950/70 p-3">
                            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Cue counts</p>
                            <ul id="definitionMeta" class="mt-2 space-y-1 text-sm text-slate-200"></ul>
                        </div>
                    </div>
                </article>

                <article class="rounded-xl border border-slate-700 bg-slate-900/80 p-4">
                    <div class="flex flex-wrap items-center gap-2">
                        <button id="playPauseBtn"
                            class="rounded bg-sky-600 px-3 py-1 text-xs font-bold text-white hover:bg-sky-500"
                            type="button">Play</button>
                        <button id="resetBtn"
                            class="rounded bg-slate-700 px-3 py-1 text-xs font-bold text-white hover:bg-slate-600"
                            type="button">Reset</button>
                        <label for="durationSelect"
                            class="ml-auto text-xs font-semibold uppercase tracking-wide text-slate-400">
                            Duration
                        </label>
                        <select id="durationSelect"
                            class="rounded border border-slate-600 bg-slate-800 px-2 py-1 text-xs font-semibold text-slate-100">
                            <option value="2200">2.2s</option>
                            <option value="3000">3.0s</option>
                            <option value="3600" selected>3.6s</option>
                            <option value="4200">4.2s</option>
                        </select>
                    </div>
                    <div class="mt-3 rounded border border-slate-700 bg-slate-950 p-2">
                        <div class="w-full aspect-[2/1]">
                            <canvas id="previewCanvas" width="360" height="180" class="w-full h-full rounded bg-slate-950"></canvas>
                        </div>
                    </div>
                    <div class="mt-2 flex items-center gap-2">
                        <label for="previewProgress"
                            class="text-xs font-semibold uppercase tracking-wide text-slate-400">Progress</label>
                        <input id="previewProgress" type="range" min="0" max="100" value="0" step="0.1"
                            class="flex-1 accent-sky-500">
                    </div>
                    <p id="previewStep" class="mt-2 text-xs text-slate-200"></p>
                    <svg id="pathPreview" viewBox="0 0 360 110"
                        class="mt-2 h-16 w-full rounded border border-slate-700 bg-slate-950">
                        <path id="previewPath" d="" fill="none" stroke="#8b5cf6" stroke-width="4" stroke-linecap="round"></path>
                        <circle id="previewMarker" cx="24" cy="84" r="6" fill="#e9d5ff"></circle>
                    </svg>
                </article>

                <article class="rounded-xl border border-slate-700 bg-slate-900/80 p-4">
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Definition JSON</p>
                    <pre id="definitionJson"
                        class="mt-2 max-h-[360px] overflow-auto rounded border border-slate-700 bg-slate-950/70 p-3 text-xs text-slate-200"></pre>
                </article>
            </section>
        </section>
    </main>

    <script>
        (function initMechanismPreview() {
            const definitions = window.OrganicMapMechanismDefinitions || {};
            const canvasRenderer = window.OrganicMapCanvasRenderer || null;
            const drawMechanismCanvasFrame =
                canvasRenderer && typeof canvasRenderer.drawMechanismCanvasFrame === 'function'
                    ? canvasRenderer.drawMechanismCanvasFrame
                    : null;
            const selectCueByStep =
                canvasRenderer && typeof canvasRenderer.selectCueByStep === 'function'
                    ? canvasRenderer.selectCueByStep
                    : null;
            const getActiveStepIndex =
                canvasRenderer && typeof canvasRenderer.getActiveStepIndex === 'function'
                    ? canvasRenderer.getActiveStepIndex
                    : null;

            const animationIds = Object.keys(definitions).sort();

            const mechanismSelect = document.getElementById('mechanismSelect');
            const mechanismCount = document.getElementById('mechanismCount');
            const definitionTitle = document.getElementById('definitionTitle');
            const definitionSummary = document.getElementById('definitionSummary');
            const definitionSteps = document.getElementById('definitionSteps');
            const definitionMeta = document.getElementById('definitionMeta');
            const definitionJson = document.getElementById('definitionJson');
            const previewCanvas = document.getElementById('previewCanvas');
            const previewPath = document.getElementById('previewPath');
            const previewMarker = document.getElementById('previewMarker');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const resetBtn = document.getElementById('resetBtn');
            const durationSelect = document.getElementById('durationSelect');
            const previewProgress = document.getElementById('previewProgress');
            const previewStep = document.getElementById('previewStep');

            const renderOptions = {
                fitToContent: true,
                preserveAspect: true,
                stretchToFill: false,
                fitScope: 'mechanism',
                strictStepCues: true,
                padding: 24,
                fitTopInset: 18,
                fitBottomInset: 20,
                fitMinScale: 0.82,
                fitMaxScale: 3.6,
                fitArrowSamples: 18,
            };

            let currentAnimationId = null;
            let currentDefinition = null;
            let currentProgress = 0;
            let previewCanvasCtx = null;
            let rafId = null;
            let isPlaying = false;
            let cycleStart = 0;
            let previewCanvasMetrics = null;

            function buildStepMilestones(steps) {
                const list = Array.isArray(steps) && steps.length > 0 ? steps : ['Mechanism step preview.'];
                const count = list.length;
                return list.map((text, index) => {
                    const start = index / count;
                    const end = (index + 1) / count;
                    return {
                        text,
                        index,
                        start,
                        end,
                    };
                });
            }

            function syncPreviewCanvas() {
                if (!previewCanvas) {
                    return null;
                }
                if (!previewCanvasCtx) {
                    previewCanvasCtx = previewCanvas.getContext('2d');
                }
                if (!previewCanvasCtx) {
                    return null;
                }

                const rect = previewCanvas.getBoundingClientRect();
                const width = Math.max(1, Math.round(rect.width));
                const height = Math.max(1, Math.round(rect.height));
                const dpr = window.devicePixelRatio || 1;
                const targetWidth = Math.max(1, Math.round(width * dpr));
                const targetHeight = Math.max(1, Math.round(height * dpr));
                const hasMetrics = previewCanvasMetrics !== null;
                const dimensionsChanged =
                    !hasMetrics ||
                    previewCanvasMetrics.width !== width ||
                    previewCanvasMetrics.height !== height ||
                    previewCanvasMetrics.dpr !== dpr;

                if (previewCanvas.width !== targetWidth || previewCanvas.height !== targetHeight) {
                    previewCanvas.width = targetWidth;
                    previewCanvas.height = targetHeight;
                }

                // Set DPR transform only when the canvas backing dimensions actually change.
                if (dimensionsChanged) {
                    previewCanvasCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
                    previewCanvasMetrics = {
                        width,
                        height,
                        dpr,
                        pixelWidth: targetWidth,
                        pixelHeight: targetHeight,
                    };
                }

                return {
                    ctx: previewCanvasCtx,
                    width,
                    height,
                    dpr,
                    pixelWidth: targetWidth,
                    pixelHeight: targetHeight,
                };
            }

            function clearPreviewCanvas() {
                const canvasState = syncPreviewCanvas();
                if (!canvasState) {
                    return null;
                }
                const { ctx, pixelWidth, pixelHeight } = canvasState;
                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0, 0, pixelWidth, pixelHeight);
                ctx.restore();
                return canvasState;
            }

            function setMarkerPosition(progressRatio) {
                const bounded = Math.max(0, Math.min(1, progressRatio));
                const pathLength = previewPath.getTotalLength();
                if (!Number.isFinite(pathLength) || pathLength <= 0) {
                    previewMarker.setAttribute('cx', '24');
                    previewMarker.setAttribute('cy', '84');
                    return;
                }
                const point = previewPath.getPointAtLength(pathLength * bounded);
                previewMarker.setAttribute('cx', point.x.toFixed(2));
                previewMarker.setAttribute('cy', point.y.toFixed(2));
            }


            function renderFallbackCanvas() {
                const canvasState = clearPreviewCanvas();
                if (!canvasState) {
                    return;
                }
                const { ctx, width, height } = canvasState;
                const gradient = ctx.createLinearGradient(0, 0, 0, height);
                gradient.addColorStop(0, '#020617');
                gradient.addColorStop(1, '#0f172a');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = '#94a3b8';
                ctx.font = '600 12px "Segoe UI", sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Shared canvas renderer unavailable', width / 2, height / 2);
            }

            function stopPlayback() {
                if (rafId !== null) {
                    window.cancelAnimationFrame(rafId);
                    rafId = null;
                }
                isPlaying = false;
                playPauseBtn.innerText = 'Play';
            }

            function setProgress(progressRatio, options = {}) {
                const bounded = Math.max(0, Math.min(1, progressRatio));
                currentProgress = bounded;

                if (options.updateSlider !== false) {
                    previewProgress.value = (bounded * 100).toFixed(1);
                }

                setMarkerPosition(bounded);

                if (!currentDefinition) {
                    previewStep.innerText = '';
                    renderFallbackCanvas();
                    return;
                }

                const steps = Array.isArray(currentDefinition.steps) && currentDefinition.steps.length
                    ? currentDefinition.steps
                    : ['Mechanism step preview.'];
                const fallbackIndex = Math.min(steps.length - 1, Math.floor(bounded * steps.length));
                const stepIndex = getActiveStepIndex
                    ? getActiveStepIndex(currentDefinition, bounded)
                    : fallbackIndex;
                previewStep.innerText = steps[Math.max(0, Math.min(stepIndex, steps.length - 1))] || 'Mechanism step preview.';

                if (drawMechanismCanvasFrame) {
                    drawMechanismCanvasFrame(currentDefinition, bounded, {
                        syncCanvas: syncPreviewCanvas,
                        mechanismId: currentAnimationId || currentDefinition.id,
                        ...renderOptions,
                    });
                    return;
                }
                renderFallbackCanvas();
            }

            function renderDefinition(animationId) {
                const definition = definitions[animationId];
                if (!definition) {
                    currentAnimationId = null;
                    currentDefinition = null;
                    definitionTitle.innerText = 'No mechanism selected';
                    definitionSummary.innerText = '';
                    definitionSteps.innerHTML = '';
                    definitionMeta.innerHTML = '';
                    definitionJson.innerText = '{}';
                    previewPath.setAttribute('d', 'M 24 84 C 92 26, 268 26, 336 84');
                    setProgress(0);
                    return;
                }

                currentAnimationId = animationId;
                currentDefinition = definition;
                definitionTitle.innerText = definition.title || animationId;
                definitionSummary.innerText = definition.summary || '';

                definitionSteps.innerHTML = '';
                buildStepMilestones(definition.steps).forEach(step => {
                    const li = document.createElement('li');
                    li.innerText = step.text;
                    definitionSteps.appendChild(li);
                });

                definitionMeta.innerHTML = '';
                const cueRows = [
                    ['Atoms', Array.isArray(definition.atoms) ? definition.atoms.length : 0],
                    ['Bonds', Array.isArray(definition.bonds) ? definition.bonds.length : 0],
                    ['Dipoles', Array.isArray(definition.dipoles) ? definition.dipoles.length : 0],
                    ['Lone pairs', Array.isArray(definition.lonePairs) ? definition.lonePairs.length : 0],
                    ['Electron arrows', Array.isArray(definition.electronMovement) ? definition.electronMovement.length : 0],
                ];

                if (selectCueByStep) {
                    const initialStepArrows = selectCueByStep(definition.electronMovement, 0).length;
                    cueRows.push(['Step 1 active arrows', initialStepArrows]);
                }

                cueRows.forEach(([label, value]) => {
                    const li = document.createElement('li');
                    li.innerText = `${label}: ${value}`;
                    definitionMeta.appendChild(li);
                });

                previewPath.setAttribute('d', typeof definition.path === 'string' ? definition.path : '');
                definitionJson.innerText = JSON.stringify(definition, null, 2);
                setProgress(0);
            }

            function tick(timestamp) {
                if (!isPlaying || !currentAnimationId) {
                    return;
                }

                if (!cycleStart) {
                    cycleStart = timestamp;
                }

                const duration = Math.max(200, Number(durationSelect.value) || 3600);
                const elapsed = timestamp - cycleStart;
                const normalized = (elapsed % duration) / duration;
                setProgress(normalized);
                rafId = window.requestAnimationFrame(tick);
            }

            playPauseBtn.addEventListener('click', () => {
                if (!currentAnimationId) {
                    return;
                }
                if (isPlaying) {
                    stopPlayback();
                    return;
                }
                isPlaying = true;
                playPauseBtn.innerText = 'Pause';
                cycleStart = 0;
                rafId = window.requestAnimationFrame(tick);
            });

            resetBtn.addEventListener('click', () => {
                stopPlayback();
                setProgress(0);
            });

            durationSelect.addEventListener('change', () => {
                if (!isPlaying) {
                    return;
                }
                const duration = Math.max(200, Number(durationSelect.value) || 3600);
                cycleStart = performance.now() - currentProgress * duration;
            });

            previewProgress.addEventListener('input', event => {
                stopPlayback();
                setProgress(Number(event.target.value || 0) / 100, { updateSlider: false });
            });

            mechanismSelect.addEventListener('change', event => {
                stopPlayback();
                renderDefinition(String(event.target.value || ''));
            });

            window.addEventListener('resize', () => {
                if (currentDefinition) {
                    setProgress(currentProgress);
                }
            });

            mechanismCount.innerText = `${animationIds.length} curated mechanisms loaded`;
            mechanismSelect.innerHTML = '';
            animationIds.forEach(animationId => {
                const option = document.createElement('option');
                option.value = animationId;
                option.innerText = animationId;
                mechanismSelect.appendChild(option);
            });

            if (!animationIds.length) {
                renderDefinition(null);
                stopPlayback();
                return;
            }

            mechanismSelect.value = animationIds[0];
            renderDefinition(animationIds[0]);
        })();
    </script>
</body>

</html>
